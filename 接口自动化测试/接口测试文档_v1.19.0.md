# 接口测试文档 v1.19.0

## 1. 版本概述

**版本号**: v1.19.0  
**发布日期**: 2024年12月  
**测试环境**: [待填写]  
**生产环境**: [待填写]  

### 1.1 主要功能更新
- **扭蛋活动系统**: 新增完整的扭蛋抽奖活动功能（用户端+管理端）
- **捐赠订单系统**: 新增币安支付捐赠功能，支持多种支付方式
- **故事书语言包**: 新增语言包上传功能
- **系统控制器**: 重构健康检查为系统信息接口
- **管理后台**: 新增活动管理功能，支持活动创建、更新、任务定义等

### 1.2 数据库变更
- 新增 `activity` 表：活动基本信息
- 新增 `activity_task_definition` 表：活动任务定义
- 新增 `activity_user_action_log` 表：用户行为记录
- 新增 `donate_order` 表：捐赠订单
- 修改 `reward_prop` 表：增加活动绑定字段
- 修改 `books_multilingual` 表：增加语音包字段

## 2. 新增接口测试

### 2.1 扭蛋活动相关接口

#### 2.1.1 获取扭蛋活动信息
**接口地址**: `GET /activity/gacha/info`  
**接口描述**: 获取当前扭蛋活动的基本信息  
**请求方式**: GET  
**是否需要认证**: 否  

**请求参数**: 无

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "activityId": 1,
    "activityName": "扭蛋抽奖",
    "activityStartTime": "2025-08-12T08:00:00",
    "activityEndTime": "2025-08-13T08:00:00",
    "activityStatus": "ACTIVE"
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| GACHA-001 | 正常获取活动信息 | 返回活动基本信息 | P1 |
| GACHA-002 | 活动未开始 | 返回NOT_STARTED状态 | P2 |
| GACHA-003 | 活动已结束 | 返回INACTIVE状态 | P2 |

---

#### 2.1.2 获取用户抽奖信息
**接口地址**: `GET /activity/gacha/user/info`  
**接口描述**: 获取用户在扭蛋活动中的抽奖次数等信息  
**请求方式**: GET  
**是否需要认证**: 是  

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| kidId | Long | 是 | 孩子ID | 123 |
| activityId | Long | 是 | 活动ID | 1 |

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "drawCount": 2,
    "shareCount": 1,
    "inviteCount": 3,
    "totalCount": 6,
    "newInviteUsers": 2,
    "activityStartTime": "2025-08-12T08:00:00",
    "activityEndTime": "2025-08-13T08:00:00"
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| GACHA-004 | 正常获取用户信息 | 返回用户抽奖次数信息 | P1 |
| GACHA-005 | 用户未参与活动 | 返回默认次数信息 | P2 |
| GACHA-006 | 无效的kidId | 返回错误信息 | P1 |
| GACHA-007 | 无效的activityId | 返回错误信息 | P1 |

---

#### 2.1.3 分享成功增加抽奖次数
**接口地址**: `POST /activity/gacha/share`  
**接口描述**: 用户分享成功后增加抽奖次数  
**请求方式**: POST  
**是否需要认证**: 是  

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| kidId | Long | 是 | 孩子ID | 123 |
| activityId | Long | 是 | 活动ID | 1 |

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "success": true,
    "message": "分享成功，获得1次抽奖机会"
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| GACHA-008 | 正常分享 | 增加抽奖次数 | P1 |
| GACHA-009 | 达到分享上限 | 返回限制信息 | P2 |
| GACHA-010 | 重复分享 | 返回已分享信息 | P2 |

---

#### 2.1.4 抽奖
**接口地址**: `POST /activity/gacha/draw`  
**接口描述**: 用户进行扭蛋抽奖  
**请求方式**: POST  
**是否需要认证**: 是  

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| kidId | Long | 是 | 孩子ID | 123 |
| activityId | Long | 是 | 活动ID | 1 |

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "rewardId": 123,
    "rewardName": "贴纸A",
    "rewardType": "STICKER",
    "rewardUrl": "/sticker.png",
    "isNew": true
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| GACHA-011 | 正常抽奖 | 返回奖励信息 | P1 |
| GACHA-012 | 抽奖次数不足 | 返回次数不足信息 | P1 |
| GACHA-013 | 活动未开始 | 返回活动未开始信息 | P2 |
| GACHA-014 | 活动已结束 | 返回活动已结束信息 | P2 |

---

#### 2.1.5 扭蛋奖励中心
**接口地址**: `GET /activity/gacha/rewardCenter`  
**接口描述**: 获取用户扭蛋奖励收集情况  
**请求方式**: GET  
**是否需要认证**: 是  

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| kidId | Long | 是 | 孩子ID | 123 |
| activityId | Long | 是 | 活动ID | 1 |

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "贴纸A",
      "url": "/sticker.png",
      "isCollected": true,
      "activityId": 1,
      "property": 1
    }
  ]
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| GACHA-015 | 正常获取奖励中心 | 返回收集情况 | P1 |
| GACHA-016 | 用户无奖励记录 | 返回空列表 | P2 |

---

### 2.2 捐赠订单相关接口 (DonateOrderController)

#### 2.2.1 创建捐赠订单
**接口地址**: `POST /donate/createDonateOrder`  
**接口描述**: 创建新的捐赠订单，支持币安支付、手动支付、钱包支付三种方式  
**请求方式**: POST  
**是否需要认证**: 否 (@PublicApi)  
**控制器**: DonateOrderController.createDonateOrder()  

**请求参数** (CreateDonateOrderRequest):
```json
{
  "amount": "100.50",
  "donorName": "张三",
  "anonymous": false,
  "currency": "USDT",
  "donorType": "individual",
  "donorEmailAddress": "donor@example.com",
  "fundSource": "personal_savings",
  "message": "希望能帮助到更多的孩子",
  "platform": "WEB",
  "donateChannel": "binance_pay",
  "networkType": "BSC",
  "transactionId": "0x1234567890abcdef"
}
```

**参数说明**:
| 参数名 | 类型 | 必填 | 验证规则 | 说明 |
|--------|------|------|----------|------|
| amount | String | 否 | 正则: ^\\d+(\\.\\d{1,8})?$ | 金额，binance_pay类型时必填 |
| donorName | String | 是 | 1-100字符 | 捐赠人姓名 |
| anonymous | Boolean | 否 | - | 是否匿名，默认false |
| currency | String | 是 | 3-10大写字母 | 货币类型 |
| donorType | String | 否 | - | 捐赠人类型 |
| donorEmailAddress | String | 是 | 邮箱格式 | 捐赠人邮箱地址 |
| fundSource | String | 否 | - | 资金来源 |
| message | String | 否 | 最大500字符 | 留言 |
| platform | String | 否 | WEB/MOBILE/APP/WAP | 平台，默认WEB |
| donateChannel | String | 是 | manual/wallet/binance_pay | 捐赠渠道 |
| networkType | String | 否 | ETH/BSC | 网络类型 |
| transactionId | String | 否 | - | 交易ID，manual类型时必传 |

**响应示例** (CreateDonateOrderResponse):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "orderId": 123456,
    "qrcodeLink": "https://pay.binance.com/qr/xxx",
    "checkoutUrl": "https://pay.binance.com/checkout/xxx",
    "expireTime": "2024-12-31T23:59:59"
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| DONATE-001 | 正常创建binance_pay订单 | 返回订单信息和支付链接 | P1 |
| DONATE-002 | 创建manual类型订单 | 返回订单ID，无支付链接 | P1 |
| DONATE-003 | 创建wallet类型订单 | 返回订单ID，无支付链接 | P1 |
| DONATE-004 | 金额为空 | 返回参数错误 | P1 |
| DONATE-005 | 邮箱格式错误 | 返回邮箱格式错误 | P1 |
| DONATE-006 | 币种不支持 | 返回币种错误 | P1 |
| DONATE-007 | 匿名捐赠 | 正常创建匿名订单 | P2 |
| DONATE-008 | manual类型缺少transactionId | 返回参数错误 | P1 |
| DONATE-009 | 平台参数错误 | 返回平台参数错误 | P2 |

---

#### 2.2.2 查询捐赠订单状态
**接口地址**: `GET /donate/donateOrderStatus/{orderId}`  
**接口描述**: 查询指定订单的支付状态  
**请求方式**: GET  
**是否需要认证**: 否 (@PublicApi)  
**控制器**: DonateOrderController.getDonateOrderStatus()  

**请求参数**:
| 参数名 | 类型 | 必填 | 验证规则 | 说明 | 示例 |
|--------|------|------|----------|------|------|
| orderId | Long | 是 | @Min(1) | 订单ID | 123456 |

**响应示例** (DonateOrderStatusResponse):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "amount": 100.50,
    "orderId": 123456,
    "paymentStatus": "SUCCESS",
    "name": "张三",
    "currency": "USDT",
    "createTime": "2024-12-01T10:00:00"
  }
}
```

**支付状态说明**:
- PENDING: 待支付
- SUCCESS: 支付成功
- FAILED: 支付失败
- CANCELLED: 已取消
- EXPIRED: 已过期

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| DONATE-010 | 正常查询订单状态 | 返回订单状态信息 | P1 |
| DONATE-011 | 订单不存在 | 返回订单不存在错误 | P1 |
| DONATE-012 | 订单ID格式错误 | 返回参数错误 | P1 |
| DONATE-013 | 匿名订单查询 | 返回anonymous作为姓名 | P2 |

---

#### 2.2.3 分页获取捐赠订单列表
**接口地址**: `GET /donate/orders`  
**接口描述**: 分页获取捐赠订单列表，支持多种筛选条件  
**请求方式**: GET  
**是否需要认证**: 否 (@PublicApi)  
**控制器**: DonateOrderController.getDonateOrderList()  

**请求参数**:
| 参数名 | 类型 | 必填 | 验证规则 | 说明 | 示例 |
|--------|------|------|----------|------|------|
| page | Int | 否 | @Min(0) | 页码，默认0 | 0 |
| size | Int | 否 | @Min(1) @Max(100) | 每页数量，默认20 | 20 |
| donorName | String | 否 | - | 捐赠人姓名 | 张三 |
| startDate | String | 否 | - | 开始日期 | 2024-01-01 |
| endDate | String | 否 | - | 结束日期 | 2024-12-31 |
| currency | String | 否 | 正则: ^[A-Z]{3,10}$ | 币种 | USDT |

**响应示例** (分页结果包含DonateOrderListResponse):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "content": [
      {
        "orderId": 123456,
        "currency": "USDT",
        "amount": 100.50,
        "donorName": "张三",
        "createTime": "2024-12-01T10:00:00",
        "transactionId": "0x1234567890abcdef",
        "paymentStatus": "SUCCESS"
      }
    ],
    "totalElements": 1,
    "totalPages": 1,
    "size": 20,
    "number": 0
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| DONATE-014 | 正常获取订单列表 | 返回分页订单列表 | P1 |
| DONATE-015 | 按捐赠人姓名筛选 | 返回筛选结果 | P2 |
| DONATE-016 | 按日期范围筛选 | 返回筛选结果 | P2 |
| DONATE-017 | 按币种筛选 | 返回筛选结果 | P2 |
| DONATE-018 | 页码超出范围 | 返回空列表 | P2 |
| DONATE-019 | 每页数量超过100 | 返回参数错误 | P2 |
| DONATE-020 | 匿名订单显示 | 显示Anonymous | P2 |

---

#### 2.2.4 获取捐赠订单详情
**接口地址**: `GET /donate/orders/{orderId}`  
**接口描述**: 获取指定订单的详细信息  
**请求方式**: GET  
**是否需要认证**: 否  

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| orderId | Long | 是 | 订单ID | 123456 |

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "orderId": 123456,
    "merchantTradeNo": "ORDER_123456",
    "prepayId": "1234567890123456789",
    "transactionId": "0x1234567890abcdef",
    "amount": 100.50,
    "currency": "USDT",
    "donorName": "张三",
    "donorEmailAddress": "donor@example.com",
    "donorType": "individual",
    "fundSource": "personal_savings",
    "message": "希望能帮助到更多的孩子",
    "anonymous": false,
    "platform": "WEB",
    "paymentStatus": "SUCCESS",
    "qrcodeLink": "https://pay.binance.com/qr/xxx",
    "checkoutUrl": "https://pay.binance.com/checkout/xxx",
    "expireTime": "2024-12-31T23:59:59",
    "createTime": "2024-12-01T10:00:00",
    "updateTime": "2024-12-01T10:05:00"
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| DONATE-014 | 正常获取订单详情 | 返回完整订单信息 | P1 |
| DONATE-015 | 订单不存在 | 返回订单不存在错误 | P1 |

---

#### 2.2.5 获取网络和币种对应关系
**接口地址**: `GET /donate/network-currency-mapping`  
**接口描述**: 获取支持的网络和币种对应关系  
**请求方式**: GET  
**是否需要认证**: 否  

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "ETH": ["USDT", "USDC"],
    "BSC": ["USDT", "USDC", "BNB"],
    "TRC20": ["USDT"]
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| DONATE-016 | 正常获取映射关系 | 返回网络币种映射 | P2 |

---

#### 2.2.6 获取支付地址
**接口地址**: `GET /donate/payment-address`  
**接口描述**: 获取指定网络和币种的支付地址  
**请求方式**: GET  
**是否需要认证**: 否  

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| networkType | String | 是 | 网络类型 | ETH |
| currency | String | 是 | 币种 | USDT |

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "address": "0x1234567890abcdef1234567890abcdef12345678"
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| DONATE-017 | 正常获取支付地址 | 返回支付地址 | P2 |
| DONATE-018 | 不支持的网络类型 | 返回错误信息 | P2 |
| DONATE-019 | 不支持的币种 | 返回错误信息 | P2 |

---

#### 2.2.7 获取汇率信息
**接口地址**: `GET /donate/exchange-rate`  
**接口描述**: 获取当前汇率信息  
**请求方式**: GET  
**是否需要认证**: 否  

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "rates": {
      "USDT": 1.0,
      "USDC": 1.0,
      "BTC": 0.000023,
      "ETH": 0.0004
    }
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| DONATE-020 | 正常获取汇率 | 返回汇率信息 | P2 |

---

#### 2.2.8 获取提现限额
**接口地址**: `GET /donate/withdraw-limit`  
**接口描述**: 获取指定币种和网络的提现限额  
**请求方式**: GET  
**是否需要认证**: 否  

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| coin | String | 是 | 币种 | USDT |
| network | String | 是 | 网络 | TRC20 |

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "minAmount": 10.0,
    "maxAmount": 10000.0,
    "fee": 1.0
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| DONATE-021 | 正常获取限额 | 返回限额信息 | P2 |

---

#### 2.2.9 取消捐赠订单
**接口地址**: `POST /donate/orders/{orderId}/cancel`  
**接口描述**: 取消指定的捐赠订单  
**请求方式**: POST  
**是否需要认证**: 否  

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| orderId | Long | 是 | 订单ID | 123456 |

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "success": true,
    "message": "订单已取消"
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| DONATE-022 | 正常取消订单 | 返回取消成功 | P2 |
| DONATE-023 | 订单不存在 | 返回订单不存在错误 | P1 |
| DONATE-024 | 订单已支付 | 返回无法取消错误 | P2 |

---

#### 2.2.10 币安支付Webhook回调
**接口地址**: `POST /donate/orders/webhook`  
**接口描述**: 处理币安支付的Webhook回调通知，包含签名验证和订单状态更新  
**请求方式**: POST  
**是否需要认证**: 否 (@PublicApi)  
**控制器**: DonateOrderController.handleBinancePayCallback()  

**请求头**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| BinancePay-Signature | String | 是 | 签名，用于验证请求合法性 |
| BinancePay-Timestamp | String | 是 | 时间戳 |
| BinancePay-Nonce | String | 是 | 随机数 |

**请求体示例** (BinancePayWebhookNotification):
```json
{
  "bizType": "PAY",
  "bizIdStr": "1234567890123456789",
  "bizId": 1234567890123456789,
  "bizStatus": "PAY_SUCCESS",
  "data": "{\"merchantTradeNo\":\"ORDER_123456\",\"productType\":\"Food\",\"productName\":\"Donation\",\"transactTime\":1701234567890,\"tradeType\":\"WEB\",\"totalFee\":100.50,\"currency\":\"USDT\",\"transactionId\":\"0x1234567890abcdef\",\"openUserId\":\"123456\",\"commission\":0.0,\"paymentInfo\":{\"payerId\":123456,\"payMethod\":\"BINANCE_PAY\",\"paymentInstructions\":[{\"currency\":\"USDT\",\"amount\":100.50,\"price\":1.0}],\"channel\":\"WEB\"}}"
}
```

**业务状态说明**:
- PAY_SUCCESS: 支付成功
- PAY_FAIL: 支付失败
- PAY_CANCEL: 支付取消
- PAY_TIMEOUT: 支付超时

**响应示例**:
```json
"success"
```

**处理流程**:
1. 验证请求头签名（如果提供）
2. 解析请求体JSON数据
3. 根据bizStatus更新订单状态
4. 记录支付日志
5. 返回"success"确认接收

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| DONATE-025 | 正常支付成功回调 | 返回success，更新订单状态 | P1 |
| DONATE-026 | 签名验证失败 | 返回Invalid signature | P1 |
| DONATE-027 | 支付失败回调 | 返回success，更新订单状态 | P2 |
| DONATE-028 | 支付取消回调 | 返回success，更新订单状态 | P2 |
| DONATE-029 | 支付超时回调 | 返回success，更新订单状态 | P2 |
| DONATE-030 | 无效的JSON格式 | 返回解析错误 | P1 |
| DONATE-031 | 订单不存在 | 返回success，记录错误日志 | P2 |

---

### 2.2.11 捐献接口总结

**DonateOrderController** 提供了完整的捐赠订单管理功能，包含以下核心特性：

#### 支付方式支持
1. **币安支付 (binance_pay)**: 集成币安支付API，支持二维码和结账页面
2. **手动支付 (manual)**: 需要提供交易ID，适用于线下转账
3. **钱包支付 (wallet)**: 直接钱包转账，需要提供支付地址

#### 核心功能
- ✅ 创建捐赠订单（支持三种支付方式）
- ✅ 查询订单状态和详情
- ✅ 分页获取订单列表（支持多条件筛选）
- ✅ 获取支付地址和汇率信息
- ✅ 获取提现限额信息
- ✅ 取消订单功能
- ✅ 币安支付Webhook回调处理

#### 安全特性
- 🔒 签名验证（Webhook回调）
- 🔒 参数验证（使用Bean Validation）
- 🔒 匿名捐赠支持
- 🔒 交易ID唯一性检查

#### 数据完整性
- 📊 完整的订单生命周期管理
- 📊 支付状态跟踪
- 📊 用户行为记录
- 📊 错误处理和日志记录

#### 相关服务类
- **DonateOrderService**: 核心业务逻辑处理
- **BinancePayService**: 币安支付API集成
- **BinancePayConfig**: 币安支付配置管理

#### 数据库实体
- **DonateOrderEntity**: 捐赠订单实体，包含完整的订单信息
- **PaymentStatus**: 支付状态枚举（PENDING, SUCCESS, FAILED, CANCELLED, EXPIRED）

#### 配置要求
```yaml
binance:
  pay:
    base-url: https://bpay.binanceapi.com
    api-key: ${BINANCE_PAY_API_KEY}
    api-secret: ${BINANCE_PAY_API_SECRET}
    merchant-id: ${BINANCE_PAY_MERCHANT_ID}
    webhook-url: ${BINANCE_PAY_WEBHOOK_URL}
    order-expire-minutes: 30
    sandbox: false

etherscan:
  api-key: ${ETHERSCAN_API_KEY}
```

---

### 2.3 管理后台活动管理接口 (AdminController)

#### 2.3.1 创建活动
**接口地址**: `POST /admin/activity/create`  
**接口描述**: 管理员创建新的活动  
**请求方式**: POST  
**是否需要认证**: 是 (@AdminApi)  
**控制器**: AdminController.createActivity()  

**请求参数** (CreateActivityReq):
```json
{
  "name": "扭蛋抽奖活动",
  "activityCode": "GACHA_2024",
  "startTime": "2024-12-01T08:00:00",
  "endTime": "2024-12-31T23:59:59",
  "config": {
    "defaultDraws": 1,
    "shareMax": 2,
    "normalStickerProbability": 0.7,
    "pointsProbability": 0.3
  },
  "status": "ACTIVE"
}
```

**响应示例** (ActivityResp):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "扭蛋抽奖活动",
    "activityCode": "GACHA_2024",
    "startTime": "2024-12-01T08:00:00",
    "endTime": "2024-12-31T23:59:59",
    "config": {...},
    "status": "ACTIVE",
    "dbCreateTime": "2024-12-01T10:00:00",
    "dbModifyTime": "2024-12-01T10:00:00"
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| ADMIN-001 | 正常创建活动 | 返回活动信息 | P1 |
| ADMIN-002 | 活动编码重复 | 返回编码已存在错误 | P1 |
| ADMIN-003 | 时间格式错误 | 返回参数错误 | P1 |
| ADMIN-004 | 配置JSON格式错误 | 返回配置错误 | P2 |

---

#### 2.3.2 更新活动
**接口地址**: `PUT /admin/activity/{activityId}`  
**接口描述**: 管理员更新活动信息  
**请求方式**: PUT  
**是否需要认证**: 是 (@AdminApi)  
**控制器**: AdminController.updateActivity()  

**请求参数** (UpdateActivityReq):
```json
{
  "name": "扭蛋抽奖活动V2",
  "startTime": "2024-12-01T08:00:00",
  "endTime": "2024-12-31T23:59:59",
  "config": {
    "defaultDraws": 2,
    "shareMax": 3
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| ADMIN-005 | 正常更新活动 | 返回更新后活动信息 | P1 |
| ADMIN-006 | 活动不存在 | 返回活动不存在错误 | P1 |
| ADMIN-007 | 部分字段更新 | 只更新指定字段 | P2 |

---

#### 2.3.3 更新活动状态
**接口地址**: `PUT /admin/activity/status`  
**接口描述**: 管理员更新活动状态  
**请求方式**: PUT  
**是否需要认证**: 是 (@AdminApi)  
**控制器**: AdminController.updateActivityStatus()  

**请求参数** (UpdateActivityStatusReq):
```json
{
  "activityId": 1,
  "status": "INACTIVE"
}
```

**活动状态**:
- ACTIVE: 激活
- INACTIVE: 停用
- NOT_STARTED: 未开始

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| ADMIN-008 | 正常更新状态 | 返回更新后活动信息 | P1 |
| ADMIN-009 | 无效状态值 | 返回状态错误 | P1 |
| ADMIN-010 | 活动不存在 | 返回活动不存在错误 | P1 |

---

#### 2.3.4 获取活动列表
**接口地址**: `GET /admin/activity/list`  
**接口描述**: 管理员获取活动列表，支持分页和筛选  
**请求方式**: GET  
**是否需要认证**: 是 (@AdminApi)  
**控制器**: AdminController.getActivityList()  

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| keyword | String | 否 | 搜索关键词 | 扭蛋 |
| status | ActivityStatus | 否 | 活动状态 | ACTIVE |
| page | Int | 否 | 页码，默认0 | 0 |
| size | Int | 否 | 每页数量，默认10 | 10 |

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| ADMIN-011 | 正常获取列表 | 返回分页活动列表 | P1 |
| ADMIN-012 | 按关键词筛选 | 返回筛选结果 | P2 |
| ADMIN-013 | 按状态筛选 | 返回筛选结果 | P2 |
| ADMIN-014 | 分页参数测试 | 返回正确分页结果 | P2 |

---

#### 2.3.5 获取活动详情
**接口地址**: `GET /admin/activity/{activityId}`  
**接口描述**: 管理员获取指定活动的详细信息  
**请求方式**: GET  
**是否需要认证**: 是 (@AdminApi)  
**控制器**: AdminController.getActivityById()  

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| ADMIN-015 | 正常获取详情 | 返回活动详细信息 | P1 |
| ADMIN-016 | 活动不存在 | 返回活动不存在错误 | P1 |

---

#### 2.3.6 活动任务管理接口

##### 2.3.6.1 创建活动任务定义
**接口地址**: `POST /admin/activity/task`  
**接口描述**: 创建活动任务定义  
**请求方式**: POST  
**是否需要认证**: 是 (@AdminApi)  

**请求参数** (CreateActivityTaskDefinitionReq):
```json
{
  "activityId": 1,
  "actionCode": "DRAW",
  "name": "每日抽奖",
  "rewardType": "DRAWS",
  "rewardValue": 1,
  "maxTimes": 1,
  "config": {
    "cooldownHours": 24
  }
}
```

##### 2.3.6.2 更新活动任务定义
**接口地址**: `PUT /admin/activity/task/{id}`  
**接口描述**: 更新活动任务定义  
**请求方式**: PUT  
**是否需要认证**: 是 (@AdminApi)  

##### 2.3.6.3 获取活动任务定义详情
**接口地址**: `GET /admin/activity/task/{id}`  
**接口描述**: 获取活动任务定义详情  
**请求方式**: GET  
**是否需要认证**: 是 (@AdminApi)  

##### 2.3.6.4 获取活动任务定义列表
**接口地址**: `GET /admin/activity/task/list`  
**接口描述**: 获取活动任务定义列表  
**请求方式**: GET  
**是否需要认证**: 是 (@AdminApi)  

##### 2.3.6.5 获取指定活动的任务定义列表
**接口地址**: `GET /admin/activity/{activityId}/task`  
**接口描述**: 获取指定活动的任务定义列表  
**请求方式**: GET  
**是否需要认证**: 是 (@AdminApi)  

##### 2.3.6.6 删除活动任务定义
**接口地址**: `DELETE /admin/activity/task/{id}`  
**接口描述**: 删除活动任务定义  
**请求方式**: DELETE  
**是否需要认证**: 是 (@AdminApi)  

**任务管理测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| ADMIN-017 | 创建任务定义 | 返回任务定义信息 | P1 |
| ADMIN-018 | 更新任务定义 | 返回更新后信息 | P1 |
| ADMIN-019 | 获取任务列表 | 返回任务列表 | P1 |
| ADMIN-020 | 删除任务定义 | 返回删除成功 | P1 |
| ADMIN-021 | 任务编码重复 | 返回编码已存在错误 | P1 |

---

### 2.4 故事书相关接口

#### 2.3.1 上传故事书语言层包
**接口地址**: `POST /book/languageLayers/upload`  
**接口描述**: 上传故事书的语言层包到S3  
**请求方式**: POST  
**是否需要认证**: 是  

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| file | MultipartFile | 是 | 语言层包文件 | - |
| bookId | Long | 是 | 故事书ID | 123 |
| languageCode | String | 是 | 语言代码 | zh-CN |

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "s3Key": "books/123/zh-CN/language_layers.zip"
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| BOOK-001 | 正常上传语言包 | 返回S3存储路径 | P1 |
| BOOK-002 | 文件为空 | 返回参数错误 | P1 |
| BOOK-003 | 无效的bookId | 返回错误信息 | P1 |
| BOOK-004 | 无效的语言代码 | 返回错误信息 | P2 |

---

### 2.4 系统相关接口

#### 2.4.1 获取系统信息
**接口地址**: `GET /system/info`  
**接口描述**: 获取系统基本信息和健康状态  
**请求方式**: GET  
**是否需要认证**: 否  

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "status": "UP",
    "version": "1.19.0",
    "buildTime": "2024-12-01T10:00:00",
    "uptime": "2 days, 5 hours, 30 minutes"
  }
}
```

**测试用例**:
| 用例ID | 测试场景 | 预期结果 | 优先级 |
|--------|----------|----------|--------|
| SYS-001 | 正常获取系统信息 | 返回系统状态信息 | P2 |

---

## 3. 修改接口测试

### 3.1 错误码更新
新增错误码：
- `ACTIVITY_NOT_FOUND(100114)`: 活动不存在
- `ACTIVITY_CODE_EXIST(100115)`: 活动编码已存在
- `ACTIVITY_EXPIRED(100116)`: 活动已过期
- `ACTIVITY_TASK_CODE_EXIST(100117)`: 活动任务编码已存在
- `ACTIVITY_TASK_NOT_FOUND(100118)`: 活动任务不存在
- `ACTIVITY_TASK_SHARE_LIMIT(100119)`: 活动分享任务限制
- `ACTIVITY_TASK_DRAW_LIMIT(100120)`: 活动抽奖任务限制
- `ORDER_NOT_FOUND(100121)`: 订单不存在
- `THIRD_PARTY_ERROR(100122)`: 第三方服务错误
- `PAYMENT_FAILED(100123)`: 支付失败
- `DONATION_AMOUNT_TOO_LOW(100124)`: 捐赠金额低于最低限额
- `DONATION_AMOUNT_TOO_HIGH(100125)`: 捐赠金额超过最高限额
- `TRANSACTION_ID_ALREADY_EXISTS(100126)`: 交易ID已存在

## 4. 数据库测试

### 4.1 新增表结构测试

#### 4.1.1 activity表
**表名**: `activity`  
**用途**: 存储活动基本信息  

**字段测试**:
| 字段名 | 类型 | 约束 | 测试用例 |
|--------|------|------|----------|
| id | BIGINT | PRIMARY KEY | 测试主键唯一性 |
| name | VARCHAR(255) | NOT NULL | 测试活动名称长度限制 |
| activity_code | VARCHAR(50) | UNIQUE | 测试活动编码唯一性 |
| start_time | TIMESTAMP | NOT NULL | 测试时间格式 |
| end_time | TIMESTAMP | NOT NULL | 测试时间格式 |
| config | JSON | NULL | 测试JSON格式 |
| status | ENUM | DEFAULT 'INACTIVE' | 测试枚举值 |

#### 4.1.2 activity_task_definition表
**表名**: `activity_task_definition`  
**用途**: 定义活动中的任务或行为模板  

**字段测试**:
| 字段名 | 类型 | 约束 | 测试用例 |
|--------|------|------|----------|
| id | BIGINT | PRIMARY KEY | 测试主键唯一性 |
| activity_id | BIGINT | NOT NULL | 测试外键关联 |
| action_code | VARCHAR(50) | NOT NULL | 测试行为编码 |
| name | VARCHAR(255) | NOT NULL | 测试任务名称 |
| reward_type | VARCHAR(50) | NULL | 测试奖励类型 |
| reward_value | INT | DEFAULT 0 | 测试奖励数值 |
| max_times | INT | NULL | 测试最大次数 |

#### 4.1.3 activity_user_action_log表
**表名**: `activity_user_action_log`  
**用途**: 记录用户行为日志  

**字段测试**:
| 字段名 | 类型 | 约束 | 测试用例 |
|--------|------|------|----------|
| id | BIGINT | PRIMARY KEY | 测试主键唯一性 |
| user_id | BIGINT | NOT NULL | 测试用户ID |
| kid_id | BIGINT | NOT NULL | 测试孩子ID |
| activity_id | BIGINT | NOT NULL | 测试活动ID |
| action_code | VARCHAR(50) | NOT NULL | 测试行为编码 |
| status | ENUM | DEFAULT 'PENDING' | 测试状态枚举 |
| result_data | JSON | NULL | 测试结果数据JSON |
| extra_params | JSON | NULL | 测试额外参数JSON |

#### 4.1.4 donate_order表
**表名**: `donate_order`  
**用途**: 存储捐赠订单信息  

**字段测试**:
| 字段名 | 类型 | 约束 | 测试用例 |
|--------|------|------|----------|
| id | BIGINT | PRIMARY KEY | 测试主键唯一性 |
| merchant_trade_no | VARCHAR(32) | UNIQUE | 测试商户订单号唯一性 |
| transaction_id | VARCHAR(200) | UNIQUE | 测试交易ID唯一性 |
| amount | DECIMAL(20,8) | NULL | 测试金额精度 |
| currency | VARCHAR(10) | NOT NULL | 测试币种格式 |
| donor_name | VARCHAR(100) | NOT NULL | 测试捐赠人姓名 |
| donor_email_address | VARCHAR(100) | NULL | 测试邮箱格式 |
| payment_status | VARCHAR(20) | DEFAULT 'PENDING' | 测试支付状态 |

### 4.2 修改表结构测试

#### 4.2.1 reward_prop表修改
**新增字段**:
- `bind_type`: 绑定类型（1-课程，2-活动）
- `activity_id`: 关联活动ID
- `property`: 道具属性（1-普通，2-隐藏款）

**修改字段**:
- `level`: 修改为BIGINT类型
- `unit`: 修改为INT类型

#### 4.2.2 books_multilingual表修改
**新增字段**:
- `voice_pack_key`: 语音包key地址

## 5. 性能测试

### 5.1 接口性能要求
| 接口类型 | 响应时间要求 | 并发用户数 | 成功率要求 |
|----------|--------------|------------|------------|
| 查询接口 | < 500ms | 1000 | > 99% |
| 创建接口 | < 1000ms | 500 | > 99% |
| 文件上传 | < 5000ms | 100 | > 95% |
| Webhook回调 | < 200ms | 100 | > 99% |

### 5.2 数据库性能测试
- 测试新增表的查询性能
- 测试索引效果
- 测试大数据量下的查询性能
- 测试并发写入性能

## 6. 安全测试

### 6.1 输入验证测试
- SQL注入测试
- XSS攻击测试
- 参数篡改测试
- 文件上传安全测试

### 6.2 认证授权测试
- 未认证访问测试
- 权限越权测试
- Token有效性测试

### 6.3 支付安全测试
- 支付回调签名验证
- 重复支付测试
- 金额篡改测试

## 7. 兼容性测试

### 7.1 浏览器兼容性
- Chrome (最新版本)
- Firefox (最新版本)
- Safari (最新版本)
- Edge (最新版本)

### 7.2 移动端兼容性
- iOS Safari
- Android Chrome
- 微信内置浏览器

### 7.3 数据库兼容性
- MySQL 8.0
- 字符集：utf8mb4
- 排序规则：utf8mb4_unicode_ci

## 8. 测试环境配置

### 8.1 测试环境要求
- **服务器配置**: 4核8G内存
- **数据库**: MySQL 8.0
- **Redis**: 6.0+
- **Java版本**: 11+
- **Spring Boot版本**: 2.7+

### 8.2 测试数据准备
- 准备测试用户数据
- 准备测试活动数据
- 准备测试订单数据
- 准备测试文件数据

## 9. 测试执行计划

### 9.1 测试阶段
1. **单元测试**: 开发完成后
2. **接口测试**: 功能开发完成后
3. **集成测试**: 所有功能完成后
4. **系统测试**: 集成测试通过后
5. **验收测试**: 系统测试通过后

### 9.2 测试时间安排
- **接口测试**: 2天
- **数据库测试**: 1天
- **性能测试**: 1天
- **安全测试**: 1天
- **兼容性测试**: 1天
- **回归测试**: 1天

## 10. 风险评估

### 10.1 高风险项
- 币安支付集成
- 文件上传功能
- 数据库结构变更
- 第三方服务依赖

### 10.2 中风险项
- 扭蛋活动逻辑
- 用户行为记录
- 数据迁移

### 10.3 低风险项
- 系统信息接口
- 错误码更新

## 11. 测试报告模板

### 11.1 测试执行结果
| 测试类型 | 用例总数 | 通过数 | 失败数 | 通过率 |
|----------|----------|--------|--------|--------|
| 扭蛋活动接口测试 | 16 | - | - | - |
| 捐赠订单接口测试 | 31 | - | - | - |
| 管理后台接口测试 | 21 | - | - | - |
| 故事书接口测试 | 4 | - | - | - |
| 系统接口测试 | 1 | - | - | - |
| 数据库测试 | 20 | - | - | - |
| 性能测试 | 10 | - | - | - |
| 安全测试 | 15 | - | - | - |
| 兼容性测试 | 12 | - | - | - |
| **总计** | **130** | - | - | - |

### 11.2 缺陷统计
| 严重级别 | 数量 | 状态 |
|----------|------|------|
| P0 | 0 | - |
| P1 | 2 | 已修复 |
| P2 | 1 | 待修复 |
| P3 | 0 | - |

## 12. 附录

### 12.1 相关文档
- API接口文档
- 数据库设计文档
- 部署文档
- 用户手册

### 12.2 联系方式
- 测试负责人: [姓名] [邮箱]
- 开发负责人: [姓名] [邮箱]
- 产品负责人: [姓名] [邮箱]

---

**文档版本**: v1.0  
**创建日期**: 2024年12月  
**最后更新**: 2024年12月  
**审核人**: [姓名]
